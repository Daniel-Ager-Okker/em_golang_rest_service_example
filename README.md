# em_golang_rest_service_example

# Тестовое приложение для управления подписками

### Установка зависимостей, сборка, тесты

Для процедур подобного рода используется make:

```bash
make dependencies # установка зависимостей
make test         # прогон юнит-тестов
make coverage     # формирование отчета покрытия тестами
make build        # сборка приложения
```

### Swagger

Спецификация находится в директории docs корня проекта.

Генерируется автоматически инструментом swaggo, принимая во внимание аннотации в коде:

```bash
swag init -d . -g ./cmd/main.go --parseInternal --parseDependency -o ./docs/
```

# Разворачивание prod-экземпляра приложения

Production версия приложения запускается с использованием docker compose.

Перед запуском необходимо создать файл `.env`, в котром указать значения следующих переменных:

- PG_USER=<имя пользователя для СУБД Postgres>

- PG_PASS=<пароль пользователя для СУБД Postgres>

Файл конфигурации, который используется для запуска - `./config/prod.yaml`. В нем следует обратить внимание на параметры:

- pg_host - имя хоста, на котором крутится БД (значение должно совпадать с именем соответствующего сервиса в `compose.yaml` файле, так как между сервисами по умолчанию создается сеть; в текущем варианте имя *db* автоматически резолвится в адрес)

- pg_port - порт, на котором БД прослушивает входящие сообщения; если поменять это значение, то в сервисе *db* файла `compose.yaml` нужно дополнительно прописать то же самое значение для *POSTGRES_PORT* (секция *environment*)

- pg_db_name - имя базы данных; должно совпадать с тем, что указано в *POSTGRES_DB* (секция *environment* сервиса *db* файла `compose.yaml`) 

Запуск:

```bash
sudo rm -rf db
docker compose build --no-cache app
docker compose up -d app
```

# Разворачивание dev-экземпляра приложения

Предусмотрена возможность локального запуска сервиса с учетом dev-среды (когда БД - файл sqlite) для удобства тестирования и проверки разрабатываемых фичей.

В ходе локального запуска сервиса автоматически инициализируется sqlite БД (файл) вместо клиент-серверной Postgres.

Запуск сервиса локально:

```bash
sudo rm -rf db                            # удаляем volume, если был
docker compose build --no-cache app-local # собираем
docker compose up -d app-local            # запускаем
```

Локальный конфигурационный файл можно найти по пути *./config/dev.yaml*, в нем следует обратить внимание на *storage_path*, представляющий собой путь к локальному файлу БД. Если поменять этот путь, то нужно должным образом изменить логику в файлах *./docker/entry_dev.sh* (команды инициализации БД) и *./docker/dev.dockerfile* (команда создания директории под БД), а также в *compose.yaml* (секция *volumes* сервиса *app*-*local*).

Рекомендуется не изменять storage_path.

# Просмотр содержимого БД

### Production-среда

Для просмотра содержимого БД приложения, что работает в prod-среде, дополнительно разворачивается pgadmin.

Запуск pgadmin:

```bash
docker compose up -d pgadmin
```

Далее (приложение должно быть поднято):

1. в браузере перейти по адресу localhost:8083

2. логинимся (admin@example.com/admin)

3. добавляем новый сервер (имя должно совпадать с именем соответствующего сервиса в `compose.yaml`, логин и пароль берутся из файла `.env`)

### Development-среда

Чтобы просматривать БД приложения, развернутого в dev-среде, достаточно открыть файл ./db/storage.db (приложение должно быть поднято).

# Просмотр логов

Возможность удобно просматривать логи предусмотрена только для prod-версии приложения. Для этого используется dozzle.

Запуск:

```bash
docker compose up -d dozzle
```

Далее в браузере перейти по адресу localhost:8084